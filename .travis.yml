services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.25.5
    - secure: "G/OBJA4AsLMxbnmMdgZRANrwiZxGagzsozpfZIGBX59m3v+9NpdBu5KQras+WkpCGKCwrHiEgUQ47z9aViYsMLn8ehKjAEzKUl/KleS9nnXbpUtCdRfvqt7QrH05u61xTqS866c7HmWZ6zbPGTwUjq7QRyVllyrVKPH84QE6s1uRR3IoJsDEBlONEVaxSs4MEAa2e/fMSDGi2c18aH3yG/NMBqW0E1iFoPbyXdQgzSKkke/Pn/zjlkqls2pbGD6mXPrgEEQPhXARoifdOlYsHUj8bxthF6e2fA/+dqtp6uQZygg4llNdyEzoMYSpaRJs08cJaez3QPy9/Ewkh7Ofk99jLf/M3C3OsSlXwK6bBKlf7It/cZTEs4or8wtO0N4LGk72fQfhWj6PfltbdW8sFeM1MuYtzwWCsKFIb8umyGnc3O7e5m8znS+1yOReZLYXGiN0mpMJEgwps3ityJNWNzZQAiyFrR3luaVr5X2TV55zl8T+EFep+nOa2MvlijLL5riKp16+sJNu58fTY2aoyYWAIDna+Fil34cxbM2xrPS9r/SqoujFST6j7nWIMSuP7nA0RwwK2uXAVmAbAk79f+Muh0T401sL4MbwwXvyRnIj2DkNgrtOGPC06HIm+FyDe54Cd5x2nXuHCr2MX9eRg0vj9Ro1DzU50c1dQRi93Tk="
    - secure: "l2hoqn8Bymy4q1Yvz/zCAfvlASJZNE209pQYl0MD8B/vzUl2/NLKykHq9TiV+a+W2hccTdJevytjxKA+aBddiKN5vs0O5VcRsP921xH9hEQlYz081f5jVgtdBNbOpCM3cI7E+Ul+zAg7fsEe5m5/r25jK4ffrgjAYh+CanO/ZlmSIrRcJ3MQyZndl4Uit0Q8JjEHcJqcYiCOetbqBVXXY2JNTXGz/ujC47dqhJK+blspK1NCq0yY7vMxA2lzsxfpZFMZG79jIepHmpAd1r0f8zs7LWI1hEU6hh3s2sYm8tpvoNHuW3EINOO9DJRxj12uybm8pbsQZmgxwGZOAK/yDjQzVDSqEReDztntHQHy1w+gyyVGd9dZVC/N++60zs5VDv0tXf+anC1iA24ASyefEj/HHTpTBDEMGEcNh/5ewSY17nsvizFlcm4MEMMnw+YNPu932dup6BOgwXkA5GPV3EAuqAbsDNgyUXnEH9ytYuuWQOK0GU8GkDcSiNOBTkJXo7z8DdhmaHWICfdvlSWhd75Mn+S9Cm9xZOLhSG3fyYR9RWwiBAuKwKfYDi00vFc8CgAqT+rCO9dDadLaMYQRuZTornWfOKMeDNKfNr2Y65ZfWkay/LW7263TVke1SUtH9WPmhADPT8K0YXwnYmXw8JKTxDlJ/4qKx2JffN5wshY="

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose version
  - echo "Login into Docker Hub"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export GIT_SHA=`git rev-parse --short HEAD`
  - echo "Building commit $GIT_SHA"

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
      - docker-compose build db
      - docker-compose build test-postgresql
      - docker-compose run test-postgresql
    - stage: tests
      name: "Static Analysis"
      script:
      - docker-compose build static-analysis
      - docker-compose run static-analysis
    - stage: push
      script:
      - docker-compose build server
      - docker tag albums_server:latest vasilevvd/albums-backend:$GIT_SHA
      - docker push vasilevvd/albums-backend:$GIT_SHA
      - docker tag albums_server:latest vasilevvd/albums-backend:$TRAVIS_BRANCH
      deploy:
        - provider: script
          script: docker push vasilevvd/albums-backend:$TRAVIS_BRANCH
          on:
            branch: master
        - provider: script
          script: docker push vasilevvd/albums-backend:$TRAVIS_TAG
          on:
            tags: True
