services:
- docker
env:
  global:
  - DOCKER_COMPOSE_VERSION=1.23.2
  - secure: YPcRm26jRR1NmO5AWfwUiQqXUFAlxbztG3Gjsjva28jly/LjHFizse5zN1MOy1ey3KTZF+gBCr5GVW5BGzaV3HtCks2FPJQQtFCnequhPcgriUEgqX4k+bhHHlynSnC8JUp9u9FBhKA11PWvZLDdWPcx+r2Vs9JzV5loQKVspLjyWvYhzhPL9F5ApbzuvCbjn10arG135bUk3Z5WGa2IPN4JYwu/ozL2wA+utSMOx7bZSj18IFGH+eL5Zy456mOiHCvwSuG3A4ih/7IOjThmeW7WT5uwMlUJmtnqZOBCyTqJ3cX+/L6fUhL4vNRgEHaFEg053w5GksN+37MDJVOrgDo4wTv8nM+uu/QlaY6EaZ0os/qo2OMpJ0KPCm1ScNypO2wLEcasUj96SHWHoXHKJjaZt1Z9QV1IacD45vq8FqeLejGuBfnRfa0QVkt4inLTrLvFPI0wwPd2FrvVfXw8UfAAO6vujWx4PPQq2D9KLQf54FPwG5pjyD3ZAAIrk3SHxXQC96alxxdGYGdAfnaU8TELGE8omXFQEfVJtnJxVm/6etYK+MaUFLrNAuIOhJ/4bMKzOzxIDDMo5HcUGyrT/bNktKNfW3xWnu9wQbFtq8q7OfBdwDvw/GPwhbiNH84V2DxRA2jM3cILBFP2Vq5AK9J1NMqQuLpXmrr1nLVjtng=
  - secure: v1c7dqbnxpC+RyTXZL8J+xDoWxMAffpbWXeCFPpNvKANTrg/LDkaerTuBWMB2QCd74wSFRViEzukTUvOdmILYP3aLjg5YF0HTNa7eivZ++gMo9CIBKwMhMhug0vBzoChmmjmrAawEC62CeKYaW9xL3Q9VaHzydOgOcRayueltBg1OXkJ4oxxiiLlHFvTPc6Hl+4iprXHE6i4Mrp15uXv98XBAE5GDcQ+9OLuJ6fPkeJ6GnecDIMMGT6QtoabSMlWvPjgxmf/IsaOLjwSrg8aLTeNoilhf32b34vZiJbyTZAr+PpCu3Qr26Fg4nyu5JBF/h0z8pa2n5sCLJqy/0ZQ/lawAjCqs/kHqiuIw+JIX7s5CcIqp/ZIzPv+Dl9ANeOLexdNQROrU0iOl+4zKpQoDaKbZfaLk8UwbfyNwwNGPeEaQLgaeSU5riVSl+PnEO1Jf94AUePiBrNw4aFSBWuPRG7ZfbE43ggPA7qRI9+uhzsbEj/MPDLY6mOS1hEA/mcrZjSdWYqwlqgYYXnAbtLjIahj4noqpnKG6+R12xIWgEhfyh5jn+X1Vxw+LU8HmFqOudDTtTduTZ9vL2k4YUIPBoLXWJ++3z346leDWgxJyTOlSpXBOa3Z9EFr+6s0lexx1g5KzhXVs+TmKT6CSRi15ebDkXJJB1zgP90DU4xQQgY=
before_install:
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
- docker --version
- docker-compose version
- echo "Login into Docker Hub"
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- export GIT_SHA=`git rev-parse --short HEAD`
- echo "Building commit $GIT_SHA"
jobs:
  include:
  - stage: tests
    name: Unit Tests
    script:
    - docker-compose build db
    - docker-compose build test-postgresql
    - docker-compose run test-postgresql
  - stage: tests
    name: Static Analysis
    script:
    - docker-compose build static-analysis
    - docker-compose run static-analysis
  - stage: push
    script:
    - docker-compose build server
    - docker tag albums_server:latest vasilevvd/albums-backend:$GIT_SHA
    - docker push vasilevvd/albums-backend:$GIT_SHA
    - docker tag albums_server:latest vasilevvd/albums-backend:$TRAVIS_BRANCH
    deploy:
    - provider: script
      script: docker push vasilevvd/albums-backend:$TRAVIS_BRANCH
      on:
        branch: master
    - provider: script
      script: docker push vasilevvd/albums-backend:$TRAVIS_TAG
      on:
        tags: true

